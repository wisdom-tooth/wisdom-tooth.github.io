<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-系统开发遇到的一些问题——系列二" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/30/系统开发遇到的一些问题——系列二/" class="article-date">
  <time datetime="2018-05-30T12:55:04.189Z" itemprop="datePublished">2018-05-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="系统开发遇到的一些问题"><a href="#系统开发遇到的一些问题" class="headerlink" title="系统开发遇到的一些问题"></a>系统开发遇到的一些问题</h1><hr>
<p>date: 2017-11-30 20:55:04<br>tags:安全笔记</p>
<hr>
<p>最近一直忙着完成一个项目系统的收尾工作，由于是第一次完整的参与一个系统开发，所以这期间遇到了大大小小的问题。直到这几天手头的事少了一些，才能有时间坐下来将之前遇到的问题做一个总结.</p>
<h2 id="2-利用PHP进行IP定位的问题"><a href="#2-利用PHP进行IP定位的问题" class="headerlink" title="2. 利用PHP进行IP定位的问题"></a>2. 利用PHP进行IP定位的问题</h2><p>系统其中一处需要用到定位用户地址的功能，考虑通过PHP来获取，其中涉及到四个参数<code>REMOTE_ADDR</code>、<code>HTTP_CLIENT_IP</code>、<code>HTTP_X_FORWARDED_FOR</code>、<code>HTTP_VIA</code>。</p>
<p>在一开始，我们先了解一下关于<strong>代理服务器</strong>的一些问题。</p>
<h3 id="根据匿名程度区分："><a href="#根据匿名程度区分：" class="headerlink" title="根据匿名程度区分："></a>根据匿名程度区分：</h3><table>
<thead>
<tr>
<th>\</th>
<th>匿名程度</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>高度匿名代理</td>
<td>高度匿名代理会将数据包原封不动的转发，在服务端看来就好像真的是一个普通客户端在访问，而记录的IP是代理服务器的IP。</td>
</tr>
<tr>
<td>2</td>
<td>普通匿名代理</td>
<td>普通匿名代理会在数据包上做一些改动，服务端上有可能发现这是个代理服务器，也有一定几率追查到客户端的真实IP。代理服务器通常会加入的HTTP头有<code>HTTP_VIA</code>和 <code>HTTP_X_FORWARDED_FOR</code>。</td>
</tr>
<tr>
<td>3</td>
<td>透明代理</td>
<td>透明代理不但改动了数据包，还会告诉服务器客户端的真实IP。这种代理除了能用缓存技术提高浏览速度，能用内容过滤提高安全性之外，并无其他显著作用。（最常见的例子是：内网中的硬件防火墙）</td>
</tr>
<tr>
<td>4</td>
<td>间谍代理</td>
<td>间谍代理指组织或个人创建的，用于记录用户传输的数据，然后进行研究、监控等目的代理服务器。</td>
</tr>
</tbody>
</table>
<p>这个小知识，在后面解释的时候会用到，下面我们接着回归正题。</p>
<p><code>REMOTE_ADDR</code> 是远端IP，默认来自tcp连接，即你的客户端跟你的服务器“握手”时候的IP。如果使用了“匿名代理”，<code>REMOTE_ADDR</code>将显示代理服务器的IP。如：<strong>a-&gt;b(proxy)-&gt;c</strong>  ,如果<strong>c</strong>通过<code>REMOTE_ADDR</code> ，只能获取到b的IP,获取不到a的IP了。另外:该IP想篡改很难实现，在传递直到生成相应的值，都是直接生成的。</p>
<p><code>HTTP_X_FORWARDED_FOR</code>，<code>HTTP_CLIENT_IP</code>是为了能在大型网络中，获取到最原始用户IP，或者代理IP地址。对HTTp协议进行扩展。定义的实体头。<br><code>HTTP_CLIENT_IP</code> 是代理服务器发送的HTTP头。如果是“超级匿名代理”，则返回none值。同样，<code>REMOTE_ADDR</code>也会被替换为这个代理服务器的IP。</p>
<p>当你使用了代理时，web服务器就不知道你的真实IP了，为了避免这个情况，代理服务器通常会增加一个叫做<code>X_Forwarded_For</code>的头信息，把连接它的客户端IP（即你的上网机器IP）加到这个头信息里，这样就能保证网站的web服务器能获取到真实IP。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP_X_FORWARDED_FOR = clientip,proxy1,proxy2</span><br></pre></td></tr></table></figure>
<p>所有IP用”,”分割,正常情况下XFF中最后一个IP地址是最后一个代理服务器的IP地址, 这通常是一个比较可靠的信息来源。 以下以x_forworded_for例子加以说明，正常情况下，这个值变化过程。<br><img src="http://omho4boal.bkt.clouddn.com/2017-11-30-0.PNG" alt="image"></p>
<p><code>HTTP_VIA（）</code><br>列出中间网关或代理服务器地址，通信协议。当客户端请求到达第一个代理服务器时，该服务器会在自己发出的请求里面添加 Via 头部，并填上自己的相关信息，当下一个代理服务器 收到第一个代理服务器的请求时，会在自己发出的请求里面复制前一个代理服务器的请求的Via 头部，并把自己的相关信息加到后面， 以此类推，当收到最后一个代理服务器的请求时，检查 Via头部，就知道该请求所经过的路由。<br>例如：</p>
<p>1、Via：1.0 236-81.D07071953.sina.com.cn:80 (squid/2.6.STABLE13)</p>
<p>2、假设来自印度的任何用户从美国的代理服务器访问四川大学网站。<br>下面我列出了虚拟IP地址的用户流量。</p>
<p>用户（印度1.25.32.51）&gt;&gt;代理（美国54.58.210.255）&gt;&gt; <a href="http://scu.edu.cn" target="_blank" rel="noopener">http://scu.edu.cn</a></p>
<p>根据上面的情况，REMOTE_ADDR将填充54.58.210.255，HTTP_VIA填充54.58.210.255，HTTP_X_FORWARDED_FOR填充1.25.32.51,54.58.210.255</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[&apos;REMOTE_ADDR&apos;]; //访问端（有可能是用户，有可能是代理的）IP</span><br><span class="line">$_SERVER[&apos;HTTP_CLIENT_IP&apos;]; //有可能存在，可伪造</span><br><span class="line">$_SERVER[&apos;HTTP_X_FORWARDED_FOR&apos;]; //用户是在哪个IP使用的代理（有可能存在，也可以伪造）</span><br></pre></td></tr></table></figure>
<p>下面比较<code>REMOTE_ADDR、HTTP_VIA、HTTP_X_FORWARDED_FOR</code>三个header头</p>
<h3 id="三个值区别如下："><a href="#三个值区别如下：" class="headerlink" title="三个值区别如下："></a>三个值区别如下：</h3><h4 id="一、没有使用代理服务器的情况："><a href="#一、没有使用代理服务器的情况：" class="headerlink" title="一、没有使用代理服务器的情况："></a>一、没有使用代理服务器的情况：</h4><p>REMOTE_ADDR = 您的 IP</p>
<p>HTTP_VIA = 没数值或不显示</p>
<p>HTTP_X_FORWARDED_FOR = 没数值或不显示</p>
<h4 id="二、使用透明代理服务器的情况"><a href="#二、使用透明代理服务器的情况" class="headerlink" title="二、使用透明代理服务器的情况"></a>二、使用透明代理服务器的情况</h4><p>REMOTE_ADDR = 最后一个代理服务器 IP </p>
<p>HTTP_VIA = 代理服务器 IP</p>
<p>HTTP_X_FORWARDED_FOR = 您的真实IP，经过多个代理服务器时，这个值类似如下：203.98.182.163, 203.98.182.163, 203.129.72.215。</p>
<p>这类代理服务器还是将您的信息转发给您的访问对象，无法达到隐藏真实身份的目的。</p>
<h4 id="三、使用普通匿名代理服务器的情况"><a href="#三、使用普通匿名代理服务器的情况" class="headerlink" title="三、使用普通匿名代理服务器的情况"></a>三、使用普通匿名代理服务器的情况</h4><p>REMOTE_ADDR = 最后一个代理服务器 IP </p>
<p>HTTP_VIA = 代理服务器 IP</p>
<p>HTTP_X_FORWARDED_FOR = 代理服务器 IP ，经过多个代理服务器时，这个值类似如下：203.98.182.163, 203.98.182.163, 203.129.72.215。</p>
<p>隐藏了您的真实IP，但是向访问对象透露了您是使用代理服务器访问他们的。</p>
<h4 id="四、使用欺骗性代理服务器的情况"><a href="#四、使用欺骗性代理服务器的情况" class="headerlink" title="四、使用欺骗性代理服务器的情况"></a>四、使用欺骗性代理服务器的情况</h4><p>REMOTE_ADDR = 代理服务器 IP </p>
<p>HTTP_VIA = 代理服务器 IP </p>
<p>HTTP_X_FORWARDED_FOR = 随机的 IP ，经过多个代理服务器时，这个值类似如下：203.98.182.163, 203.98.182.163, 203.129.72.215。</p>
<p>告诉了访问对象您使用了代理服务器，但编造了一个虚假的随机IP代替您的真实IP欺骗它。</p>
<h4 id="五、使用高匿名代理服务器的情况"><a href="#五、使用高匿名代理服务器的情况" class="headerlink" title="五、使用高匿名代理服务器的情况"></a>五、使用高匿名代理服务器的情况</h4><p>REMOTE_ADDR = 代理服务器 IP</p>
<p>HTTP_VIA = 没数值或不显示</p>
<p>HTTP_X_FORWARDED_FOR = 没数值或不显示</p>
<p>完全用代理服务器的信息替代了您的所有信息，就象您就是完全使用那台代理服务器直接访问对象。</p>
<hr>
<h3 id="一个小点："><a href="#一个小点：" class="headerlink" title="一个小点："></a>一个小点：</h3><p>前面提到的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[&apos;HTTP_CLIENT_IP&apos;]; //可以伪造</span><br><span class="line">$_SERVER[&apos;HTTP_X_FORWARDED_FOR&apos;]; //可以伪造</span><br></pre></td></tr></table></figure></p>
<p>那么对于一些利用这两个值获取用户IP 的地方，就存在通过修改这两个值来进行xss攻击的可能。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/30/系统开发遇到的一些问题——系列二/" data-id="cjht4i2dh0000jcuajaa8ux70" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/05/30/系统开发遇到的一些问题——系列二/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>